#!/usr/bin/env bash

set -euo pipefail

# Color support: check NO_COLOR or non-TTY (stdout)
if [ -n "${NO_COLOR+x}" ] || [ ! -t 1 ]; then
  CYAN=''
  GREEN=''
  YELLOW=''
  BLUE=''
  PURPLE=''
  RED=''
  BOLD=''
  DIM=''
  NC=''
else
  CYAN='\033[0;36m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  BLUE='\033[0;34m'
  PURPLE='\033[0;35m'
  RED='\033[0;31m'
  BOLD='\033[1m'
  DIM='\033[2m'
  NC='\033[0m'
fi

BASE_URL="${JAKUB_SH_BASE_URL:-https://jakub.sh}"
BASE_URL="${BASE_URL%/}"

print_step() {
  echo -e "${DIM}▸ ${1}${NC}"
}

print_success() {
  echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
  echo -e "${RED}✗ ${1}${NC}"
}

print_warning() {
  echo -e "${YELLOW}! ${1}${NC}"
}

echo ""
echo -e "${BOLD}jakub.sh${NC} tools installer${NC}"
echo ""

print_step "Ensuring bin directory exists at ~/.local/bin..."
mkdir -p ~/.local/bin

SEKEY_URL="${BASE_URL}/sekey/sekey.sh"
JAI_URL="${BASE_URL}/jai/jai.sh"
JAI_HOOKS_URL="${BASE_URL}/jai/jai-cursorhooks.sh"

if [ "$#" -gt 1 ]; then
  print_error "Too many arguments."
  echo "Usage: bash -s [sekey,jai]"
  exit 1
fi

INSTALL_SEKEY=false
INSTALL_JAI=false

if [ "$#" -eq 0 ] || [ -z "${1}" ]; then
  INSTALL_SEKEY=true
  INSTALL_JAI=true
else
  IFS=',' read -r -a REQUESTED_TOOLS <<< "${1}"
  for raw_tool in "${REQUESTED_TOOLS[@]}"; do
    tool="${raw_tool//[[:space:]]/}"
    case "$tool" in
      sekey) INSTALL_SEKEY=true ;;
      jai) INSTALL_JAI=true ;;
      "")
        ;;
      *)
        print_error "Unknown tool: ${tool}"
        echo "Available tools: sekey,jai"
        exit 1
        ;;
    esac
  done
fi

if [ "$INSTALL_SEKEY" = false ] && [ "$INSTALL_JAI" = false ]; then
  print_error "No tools selected."
  echo "Usage: bash -s [sekey,jai]"
  exit 1
fi

install_tool() {
  local name="$1"
  local url="$2"
  local target="$3"
  local temp_file

  print_step "Downloading ${name}..."
  temp_file=$(mktemp)

  if curl -fsSL "$url" -o "$temp_file"; then
    chmod +x "$temp_file"
    mv "$temp_file" "$target"
    print_success "Installed: ${name}"
  else
    rm -f "$temp_file"
    print_error "Download failed: ${name}"
    exit 1
  fi
}

if [ "$INSTALL_SEKEY" = true ]; then
  install_tool "sekey" "$SEKEY_URL" "$HOME/.local/bin/sekey"
fi

if [ "$INSTALL_JAI" = true ]; then
  install_tool "jai" "$JAI_URL" "$HOME/.local/bin/jai"
  install_tool "jai-cursorhooks" "$JAI_HOOKS_URL" "$HOME/.local/bin/jai-cursorhooks"
fi

if [ "$INSTALL_JAI" = true ] && ! command -v jq >/dev/null 2>&1; then
  print_warning "jq not found. jai-cursorhooks JSON parsing needs jq."
  print_warning "Install jq, then run: jai install-cursorhooks"
fi

echo ""
print_success "Installation complete!"
echo ""
echo "Optional Cursor integration:"
echo "  jai install-cursorhooks [directory]   # writes .cursor/hooks.json (directory defaults to ~)"
echo ""

if [[ ":${PATH}:" == *":${HOME}/.local/bin:"* ]]; then
  echo "Run:"
  echo "  sekey --help"
  echo "  jai --help"
  echo ""
  echo -e "${DIM}See more at ${BLUE}https://jakub.sh${NC}"
else
  echo -e "${BOLD}Add ~/.local/bin to your PATH:${NC}"
  echo ""

  SHOW_BASH=false
  SHOW_ZSH=false
  SHOW_FISH=false
  [ -f "$HOME/.bashrc" ] || [ -f "$HOME/.bash_profile" ] && SHOW_BASH=true
  [ -f "$HOME/.zshrc" ] && SHOW_ZSH=true
  [ -f "$HOME/.config/fish/config.fish" ] && SHOW_FISH=true
  case "$(basename "$SHELL")" in
  bash) SHOW_BASH=true ;;
  zsh) SHOW_ZSH=true ;;
  fish) SHOW_FISH=true ;;
  esac

  if [ "$SHOW_BASH" = true ]; then
    echo -e "  ${DIM}bash:${NC}"
    echo -e "  ${BOLD}echo 'export PATH=\"\$HOME/.local/bin:\$PATH\"' >> ~/.bashrc && source ~/.bashrc"
    echo ""
  fi
  if [ "$SHOW_ZSH" = true ]; then
    echo -e "  ${DIM}zsh:${NC}"
    echo -e "  ${BOLD}echo 'export PATH=\"\$HOME/.local/bin:\$PATH\"' >> ~/.zshrc && source ~/.zshrc"
    echo ""
  fi
  if [ "$SHOW_FISH" = true ]; then
    echo -e "  ${DIM}fish:${NC}"
    echo -e "  ${BOLD}mkdir -p ~/.config/fish && echo 'fish_add_path \$HOME/.local/bin' >> ~/.config/fish/config.fish"
    echo ""
  fi
  if [ "$SHOW_BASH" != true ] && [ "$SHOW_ZSH" != true ] && [ "$SHOW_FISH" != true ]; then
    echo -e "  ${DIM}export PATH=\"\$HOME/.local/bin:\$PATH\"${NC}"
    echo ""
  fi
fi
echo ""
